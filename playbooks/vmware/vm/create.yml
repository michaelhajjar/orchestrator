--- 
- name: Generate uuid for hostname of server
  command: uuidgen
  register: randomuuidgen

- set_fact:
    hostname: '{{ naming_convention }}{{ rol }}_{{ bedrijfsnaam }}_{{ randomuuidgen.stdout|lower }}'

- name: Create sub folder if it does not exist
  include_role:
    name: vmware
    tasks_from: create_sub_folder

- name: Create the Virtual Machine on VMWare
  include_role:
    name: vmware
    tasks_from: create_vm

- name: Append VM info in dict
  set_fact:
    vm_created: "{'vm_name': {{ virtualmachinecreated.instance.hw_name }}, 'vm_ipv4_addres': {{ virtualmachinecreated.instance.ipv4 }} }"

- name: Add the new VM to a in-memory inventory
  add_host:
    name: '{{ virtualmachinecreated.instance.ipv4 }}'
    groups: '{{ bedrijfsnaam }}_{{ rol }}_{{ omgeving }}'
    ansible_ssh_user: '{{ ansible_ssh_user }}'
    ansible_ssh_private_key: '{{ ansible_ssh_private_key }}'
    ansible_become: true

- name: set fqdn in OS
  command: hostnamectl set-hostname '{{ hostname }}.{{ domain}}'
  register: hostnamecmd
  delegate_to: '{{ virtualmachinecreated.instance.ipv4 }}'

- name: Ensure that '{{ hostname }}' is in '{{ rol }}' section of the inventory file 
  ini_file:
    path: './inventories/provisioner.ini'
    section: '{{ bedrijfsnaam }}_{{ rol }}_{{ omgeving }}'
    option: '{{ hostname}}.{{ domain}} ansible_host={{ virtualmachinecreated.instance.ipv4 }} ansible_ssh_user={{ ansible_ssh_user }} ansible_ssh_private_key={{ ansible_ssh_private_key }} platform={{ platform }} bedrijf={{ bedrijfsnaam }} aanvrager={{ voornaam }}'
    allow_no_value: yes
    create: yes
  vars:
    ansible_python_interpreter: /usr/bin/python

- name: Set attributes on the VM
  include_role:
    name: vmware
    tasks_from: set_vm_attributes

- name: Append VM info in final dict
  set_fact:
    vm_created: "{{ final_vm_created + [vm_created] }}"