---
- name: Start de orchestrator!
  hosts: localhost
  tasks:
    - pause:
        prompt: "Welkom bij de orchestrator van Michael Hajjar!\nde orchestrator is gemaakt voor VM2 en heeft als doel snel virtuele machines aanmaken, aanpassen of verwijderen.\nVoordat u een VM kunt aanvragen, hebben wij informatie nodig.\nVolg de wizard en vul de vragen in (het kan 10 minuten duren voordat een actie is uitgevoerd).\n\nBent u een bestaande klant of een nieuwe klant?:\n \n- Bestaande klant (typ bestaand) \n- Nieuwe klant    (typ nieuw) \n"
      register: menu_klant

    - pause:
        prompt: "\nWat is uw voornaam?: \n"
      register: menu_voornaam

    - pause:
        prompt: "\nWat is uw achternaam?: \n"
      register: menu_achternaam

    - pause:
        prompt: "\nWat is uw bedrijfsnaam?: \n"
      register: menu_bedrijfsnaam

    - pause:
        prompt: "Wat wilt u doen?: \n\n- een VM aanmaken    (typ create) \n- een VM aanpassen   (typ modify) \n- een VM verwijderen (typ delete) \n"
      register: menu_vm

    - pause:
        prompt: "\nIn welke omgeving wilt u de VM aannmaken, aanpassen of verwijderen?:\n \n- ontwikkel  (typ ontwikkel) \n- test       (typ test) \n- acceptatie (typ acceptatie) \n- productie  (typ productie) \n"
      register: menu_env

    - pause:
        prompt: "\nOp welke platform wilt u de VM aannmaken?:\n \n- VMWare (typ vmware) \n- Azure  (typ azure) \n- AWS    (typ aws)\n"
      register: menu_platform
      when: menu_vm.user_input == 'create'

    - pause:
        prompt: "\nWat voor flavor heeft de VM?:\n \n- 128MB RAM, 1 core, 10GB disk (typ micro.1) \n- 256MB RAM, 1 core, 15GB disk (typ micro.2) \n- 512MB RAM, 1 core, 20GB disk (typ small.1) \n"
      register: menu_flavor
      when: menu_vm.user_input == 'create'

    - pause:
        prompt: "\nHoeveel instanties wilt u hebben?: \n"
      register: menu_instances 
      when: menu_vm.user_input == 'create' 

    - name: Setting the facts that the client has given
      set_fact:
        voornaam: "{{ menu_voornaam.user_input|lower }}"
        achternaam: "{{ menu_achternaam.user_input|lower }}"
        bedrijfsnaam: "{{ menu_bedrijfsnaam.user_input|lower }}"
        omgeving: "{{ menu_env.user_input }}"
        platform: "{{ menu_platform.user_input|default('n.v.t.') }}"
        flavor: "{{ menu_flavor.user_input|default('n.v.t.') }}"
        operation: "{{ menu_vm.user_input }}"
        aantal_instanties: "{{ menu_instances.user_input|default('n.v.t.') }}"
        final_vm_created: []

    - pause:
        prompt: "\nU heeft de volgende informatie ingevoerd, is dit correct (opties ja of nee): \n\nVoornaam: {{ voornaam }} \nAchternaam: {{ achternaam }} \nBedrijfsnaam: {{ bedrijfsnaam }} \nOmgeving: {{ omgeving }} \nPlatform: {{ platform }} \nFlavor: {{ flavor }} \nActie: {{ operation }} VM \nAantal instanties: {{ aantal_instanties }} \n\n"
      register: final_information_acc

    - fail:
        msg: U heeft nee ingevuld. Voer de Orchestrator opnieuw uit.
      when: final_information_acc.user_input == 'nee'
    
    - name: Include vars
      include_vars: '{{ item }}'
      loop:
        - './vars/env/all'
        - './vars/env/{{ omgeving }}'

    - name: Include vars
      include_vars: './vars/flavors/{{ flavor }}'
      when: operation != 'delete'

    - name: Run operation create 
      include: "./playbooks/{{ platform }}/vm/create.yml"
      with_sequence: count='{{ aantal_instanties }}'
      when: operation == 'create'

    - name: Run operation delete 
      include: "./playbooks/{{ platform }}/vm/delete.yml"
      with_sequence: count='{{ aantal_instanties }}'
      when: operation == 'create' 